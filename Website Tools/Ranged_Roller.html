<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ranged Combat Simulation</title>
<link href="style.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>
<p><a href="index.html"><img src="flame_dimetap.gif"></a></p>
    <ul>
  <li><a href="index.html">Home</a></li>
  <li><a href="Rules_JASCI.html">JASCI TRPG Rules</a></li>
  <li><a href="JASCI_Melee_Roller.html">JASCI Melee Roller</a></li>
  <li><a href="JASCI_Ranged_Roller.html">JASCI Ranged Roller</a></li>
  <li><a href="JASCI_Thrown_Roller.html">JASCI Thrown Roller</a></li>
  <li><a href="JASCI_XP_Calculator.html">JASCI XP Calculator</a></li>
  <li><a href="monsters_and_men.html">Monsters and Men</a></li>
</ul>
<img src="under_construction.gif">
<img src="cowboy.gif">
<h1>JASCI Ranged Combat Simulation</h1>
<form id="combatForm">
  <h2>Ranged</h2>
  <h3>Attacker</h3>
  <button type="button" onclick="loadCharacter('attacker')">Load Character/Creature File</button><br> <!-- Button to load attacker's data -->
  <label for="attackerName">Attacker Name:</label>
  <input type="text" id="attackerName" placeholder="Enter attacker's name"><br>
  
  <label for="attackerGunSkill" style="background-color: magenta;">Gun Skill:</label>
  <input type="number" id="attackerGunSkill" name="attackerGunSkill" placeholder="Enter gun skill"><br>

  <label for="attackerGunType">Gun Type:</label>
  <select id="attackerGunType" name="attackerGunType">
    <option value="Shotgun">Shotgun</option>
    <option value="Pistol">Pistol</option>
    <option value="Rifle">Rifle</option>
    <option value="Sniper">Sniper</option>
    <option value="Bow">Bow</option>
  </select><br>

  <label for="attackerRangedWeaponDamageDice">Ranged Weapon Damage Dice:</label>
  <input type="text" id="attackerRangedWeaponDamageDice" name="attackerRangedWeaponDamageDice" placeholder="e.g., 1d4"><br>

  <label for="attackerRangedWeaponDamageModifier">Ranged Weapon Damage Modifier:</label>
  <input type="number" id="attackerRangedWeaponDamageModifier" name="attackerRangedWeaponDamageModifier" placeholder="Enter damage modifier"><br>

  <label for="range">Range:</label>
  <select id="range" name="range">
    <option value="Point-blank">Point-blank</option>
    <option value="Close">Close</option>
    <option value="Medium">Medium</option>
    <option value="Long">Long</option>
    <option value="Very long">Very long</option>
    <option value="Extremely long">Extremely long</option>
  </select><br>
  
  <label for="targetedBodyPart">Targeted Body Part:</label>
  <select id="targetedBodyPart" name="targetedBodyPart">
    <option value="Head">Head: -4</option>
    <option value="Torso">Torso: 0</option>
    <option value="Left Arm">Left Arm: -1</option>
    <option value="Left Hand">Left Hand: -2</option>
    <option value="Right Arm">Right Arm: -1</option>
    <option value="Right Hand">Right Hand: -2</option>
    <option value="Left Leg">Left Leg: -1</option>
    <option value="Left Foot">Left Foot: -2</option>
    <option value="Right Leg">Right Leg: -1</option>
    <option value="Right Foot">Right Foot: -2</option>
  </select><br>

  <label for="modeOfFire">Mode of Fire:</label>
  <select id="modeOfFire" name="modeOfFire">
    <option value="Single">Single Shot</option>
    <option value="Burst">Burst</option>
    <option value="Automatic">Automatic</option>
  </select><br>

  <p id="attackerInfo">Hit Modifier: <span id="hitModifier">0</span>, Damage Modifier: <span id="damageModifier">0</span>, Probability: <span id="probability">0%</span></p>
  
  <h3>Defender</h3>
  <button type="button" onclick="loadCharacter('defender')">Load Character/Creature File</button><br> <!-- Button to load defender's data -->
  <label for="defenderName">Defender Name:</label>
  <input type="text" id="defenderName" placeholder="Enter defender's name"><br>
  
  <label for="defenderBodyPartArmor">Body Part Armor:</label>
  <input type="number" id="defenderBodyPartArmor" name="defenderBodyPartArmor" placeholder="Enter targeted armor rating"><br>

  <label for="isDefenderMoving">Is the defender moving?</label>
  <input type="checkbox" id="isDefenderMoving" name="isDefenderMoving"><br>

  <label for="degreeOfCover">Degree of Cover:</label>
  <select id="degreeOfCover" name="degreeOfCover">
    <option value="None">None</option>
    <option value="One-quarter">One-quarter</option>
    <option value="One-half">One-half</option>
    <option value="Three-quarters">Three-quarters</option>
    <option value="Nine-tenths">Nine-tenths</option>
    <option value="Total">Total</option>
  </select><br>

  <p id="defenderInfo">Defense Roll Modifier: <span id="defenseModifier">0</span>, Damage Mitigation: <span id="damageMitigation">0</span></p>

  <button type="button" onclick="resolveCombat()">Resolve Combat</button>
  
  <textarea id="consoleOutput" rows="10" cols="50"></textarea>
</form>

<script>
    function appendToConsoleLog(log) {
    const consoleOutput = document.getElementById('consoleOutput');
    consoleOutput.value += log + '\n';
    }
    // Function to roll dice
    function rollDice(numDice, numSides) {
        let total = 0;
        for (let i = 0; i < numDice; i++) {
            total += Math.floor(Math.random() * numSides) + 1;
        }
        return total;
    }

  function calculateHitModifier(targetedBodyPart, gunType, range, modeOfFire, gunSkill) {
      const bodyPartModifiers = {
          'Head': -4,
          'Torso': 0,
          'Left Arm': -1,
          'Left Hand': -2,
          'Right Arm': -1,
          'Right Hand': -2,
          'Left Leg': -1,
          'Left Foot': -2,
          'Right Leg': -1,
          'Right Foot': -2
      };

      let modifier = bodyPartModifiers[targetedBodyPart] + gunSkill;

      // Range modifier
      const rangeModifiers = {
          'Point-blank': 15,
          'Close': 5,
          'Medium': 0,
          'Long': -5,
          'Very long': -10,
          'Extremely long': -15
      };
      modifier += rangeModifiers[range] || 0;

      // Specific gun type range adjustments
      const gunRangeAdjustments = {
          'Shotgun': (range === 'Long' || range === 'Very long' || range === 'Extremely long') ? -2 : 0,
          'Rifle': (range === 'Long' || range === 'Very long' || range === 'Extremely long') ? 2 : 0,
          'Sniper': (range === 'Long' || range === 'Very long' || range === 'Extremely long') ? 5 : 0,
          'Bow': (range === 'Long' || range === 'Very long' || range === 'Extremely long') ? -3 : 0,
      };
      modifier += gunRangeAdjustments[gunType] || 0;

      // Mode of fire adjustments
      const fireModeAdjustments = {
          'Single': 0,
          'Burst': -5,
          'Automatic': -8
      };
      modifier += fireModeAdjustments[modeOfFire] || 0;

      return modifier;
  }

  function calculateDefenseModifier(degreeOfCover, isDefenderMoving, bodyPartArmor) {
      const coverModifiers = {
          'None': 0,
          'One-quarter': 2,
          'One-half': 4,
          'Three-quarters': 7,
          'Nine-tenths': 10,
          'Total': Infinity // Represents no line of sight, hence, an automatic miss
      };

      let modifier = coverModifiers[degreeOfCover] || 0;
      if (isDefenderMoving) {
          modifier += 2;
      }
      modifier += bodyPartArmor;

      return modifier;
  }

  // Function to calculate the probability of Attacker Roll being higher than Defender Roll
  function calculateProbability(attackerModifier, defenderModifier) {
      const numSides = 20; // Assuming both Attacker and Defender are rolling d20

      // Calculate the probability of each outcome for Attacker and Defender Rolls
      const attackerProbabilities = Array.from({ length: numSides }, (_, i) => 1 / numSides); // Each outcome has an equal probability
      const defenderProbabilities = Array.from({ length: numSides }, (_, i) => 1 / numSides);

      // Initialize total probability
      let totalProbability = 0;

      // Sum up the probabilities of Attacker Roll being higher than Defender Roll
      for (let i = 0; i < numSides; i++) {
          for (let j = 0; j < numSides; j++) {
              if (i + 1 + attackerModifier > j + 1 + defenderModifier) {
                  totalProbability += attackerProbabilities[i] * defenderProbabilities[j];
              }
          }
      }

      return totalProbability * 100; // Convert to percentage
  }

  // Test with both modifiers as 0
  console.log(calculateProbability(0, 0)); // Output should be approximately 47.5%

  
  function updateDisplay() {
      const attackerGunSkill = parseInt(document.getElementById('attackerGunSkill').value) || 0;
      const attackerGunType = document.getElementById('attackerGunType').value;
      const range = document.getElementById('range').value;
      const modeOfFire = document.getElementById('modeOfFire').value;
      const targetedBodyPart = document.getElementById('targetedBodyPart').value;
      const attackerRangedWeaponDamageModifier = parseInt(document.getElementById('attackerRangedWeaponDamageModifier').value) || 0;

      const defenderBodyPartArmor = parseInt(document.getElementById('defenderBodyPartArmor').value) || 0;
      const isDefenderMoving = document.getElementById('isDefenderMoving').checked;
      const degreeOfCover = document.getElementById('degreeOfCover').value;

      const hitModifier = calculateHitModifier(targetedBodyPart, attackerGunType, range, modeOfFire, attackerGunSkill);
      const defenseModifier = calculateDefenseModifier(degreeOfCover, isDefenderMoving, defenderBodyPartArmor);
      const probability = calculateProbability(hitModifier, defenseModifier);

      document.getElementById('hitModifier').textContent = hitModifier;
      document.getElementById('damageModifier').textContent = attackerRangedWeaponDamageModifier;
      document.getElementById('defenseModifier').textContent = defenseModifier;
      document.getElementById('damageMitigation').textContent = defenderBodyPartArmor;
      document.getElementById('probability').textContent = probability.toFixed(2) + '%';
  }

  // Event listeners for attacker fields
  document.getElementById('attackerGunSkill').addEventListener('input', updateDisplay);
  document.getElementById('attackerRangedWeaponDamageModifier').addEventListener('input', updateDisplay);
  document.getElementById('attackerGunType').addEventListener('change', updateDisplay);
  document.getElementById('range').addEventListener('change', updateDisplay);
  document.getElementById('targetedBodyPart').addEventListener('change', updateDisplay);
  document.getElementById('modeOfFire').addEventListener('change', updateDisplay);

  // Event listeners for defender fields
  document.getElementById('defenderBodyPartArmor').addEventListener('input', updateDisplay);
  document.getElementById('isDefenderMoving').addEventListener('change', updateDisplay);
  document.getElementById('degreeOfCover').addEventListener('change', updateDisplay);
  
    function resolveCombat() {
      // Get attacker variables
      const attackerGunSkill = parseInt(document.getElementById('attackerGunSkill').value) || 0;
      const attackerGunType = document.getElementById('attackerGunType').value;
      const attackerRangedWeaponDamageDice = document.getElementById('attackerRangedWeaponDamageDice').value;
      const attackerRangedWeaponDamageModifier = parseInt(document.getElementById('attackerRangedWeaponDamageModifier').value) || 0;
      const range = document.getElementById('range').value;
      const targetedBodyPart = document.getElementById('targetedBodyPart').value;
      const modeOfFire = document.getElementById('modeOfFire').value;

      // Get defender variables
      const defenderBodyPartArmor = parseInt(document.getElementById('defenderBodyPartArmor').value) || 0;
      const isDefenderMoving = document.getElementById('isDefenderMoving').checked;
      const degreeOfCover = document.getElementById('degreeOfCover').value;

      let attackModifier = calculateHitModifier(targetedBodyPart, attackerGunType, range, modeOfFire, attackerGunSkill);
      
      // Roll a d20 for attacker's attack
      const attackerRoll = Math.floor(Math.random() * 20) + 1 + attackModifier;
      appendToConsoleLog('Attacker roll:' + attackerRoll + ' ' + 'd20+' + attackModifier);

      // Calculate defense modifier based on cover, movement, and armor
      let defenseModifier = calculateDefenseModifier(degreeOfCover, isDefenderMoving, defenderBodyPartArmor);
      
      // Roll a d20 for defender's defense
      let defenderRoll = Math.floor(Math.random() * 20) + 1 + defenseModifier;      
      appendToConsoleLog('Defender roll:' + defenderRoll + ' ' + 'd20+' + defenseModifier);

      // Check if the attacker hits
      let hit = false;
      if (attackerRoll > defenderRoll || attackerRoll === 20) {
          hit = true;
          appendToConsoleLog('Attack hits!');
      } else {
          appendToConsoleLog('Attack misses!');
      }

      // Resolve damage if the attacker hits
      if (hit) {
          // Roll damage
          let damageRoll = 0;
          let numberOfShots = 0;
          switch (modeOfFire) {
              case 'Single':
                  damageRoll = Math.floor(Math.random() * parseInt(attackerRangedWeaponDamageDice.split('d')[1])) + 1;
                  numberOfShots = 1;
                  break;
              case 'Burst':
                  damageRoll = Math.floor(Math.random() * parseInt(attackerRangedWeaponDamageDice.split('d')[1])) + 1;
                  numberOfShots = Math.floor(Math.random() * 3) + 1; // Roll a d3
                  break;
              case 'Automatic':
                  damageRoll = Math.floor(Math.random() * parseInt(attackerRangedWeaponDamageDice.split('d')[1])) + 1;
                  // Roll a d6 with disadvantage to see how many bullets hit
                  const roll1 = Math.floor(Math.random() * 6) + 1;
                  const roll2 = Math.floor(Math.random() * 6) + 1;
                  numberOfShots = Math.min(roll1, roll2); // Take the lower roll
                  break;
              default:
                  break;
          }

          for (let i = 0; i < numberOfShots; i++) {
              // Roll damage for each shot
              const [numDice, numSides] = attackerRangedWeaponDamageDice.split('d').map(Number);
              const shotDamageRoll = rollDice(numDice, numSides);
              let totalDamage = shotDamageRoll + attackerRangedWeaponDamageModifier - defenderBodyPartArmor;
              if (totalDamage < 0) {
                  totalDamage = 0;
              }
              appendToConsoleLog('Damage from shot ' + (i + 1) + ': ' + totalDamage + ' ' + attackerRangedWeaponDamageDice + '+' + attackerRangedWeaponDamageModifier + '-' + defenderBodyPartArmor);
          }
  

          // Display affected body part
          appendToConsoleLog('Damage applied to ' + targetedBodyPart);
      }
    }
    // Function to load character data from a JSON file
    function loadCharacter(role) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'application/json';
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = JSON.parse(event.target.result);
                if (role === 'attacker') {
                    fillAttackerFields(data);
                } else if (role === 'defender') {
                    fillDefenderFields(data);
                }
            };
            reader.readAsText(file);
        });
        fileInput.click();
    }

    // Function to fill attacker's fields with data from the loaded character
    function fillAttackerFields(data) {
        document.getElementById('attackerName').value = data.name;
        // Fill other attacker fields
        if (data.stats) {
            document.getElementById('attackerGunSkill').value = parseInt(data.stats.Guns_Skill) || 0;
            // Add other stats as needed
        }
    }

    // Function to fill defender's fields with data from the loaded character
    function fillDefenderFields(data) {
        document.getElementById('defenderName').value = data.name;
        // Fill other defender fields
    }
</script>
</body>
</html>